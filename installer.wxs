<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" 
           Name="SnipperClone - DataSnipper Alternative" 
           Language="1033" 
           Version="1.0.0.0" 
           Manufacturer="Internal Development Team" 
           UpgradeCode="12345678-ABCD-EFGH-1234-123456789012">
    
    <Package InstallerVersion="200" 
             Compressed="yes" 
             InstallScope="perMachine" 
             Description="Professional Excel add-in for document analysis and data extraction"
             Comments="SnipperClone provides advanced OCR, table parsing, and document processing capabilities for Excel"
             Manufacturer="Internal Development Team"
             Keywords="Excel,Add-in,OCR,DataSnipper,Document,Analysis" />

    <!-- Major upgrade configuration -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    
    <!-- Media and compression -->
    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- Custom properties -->
    <Property Id="ARPPRODUCTICON" Value="SnipperCloneIcon.exe" />
    <Property Id="ARPHELPLINK" Value="https://github.com/yourorg/snipperclone" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/yourorg/snipperclone" />
    <Property Id="ARPNOMODIFY" Value="1" />
    <Property Id="ARPNOREPAIR" Value="1" />
    
    <!-- Prerequisites check -->
    <Property Id="NETFRAMEWORK48">
      <RegistrySearch Id="NetFramework48" 
                      Root="HKLM" 
                      Key="SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" 
                      Name="Release" 
                      Type="raw" />
    </Property>
    
    <!-- Office version check -->
    <Property Id="OFFICEVERSION">
      <RegistrySearch Id="OfficeVersion" 
                      Root="HKLM" 
                      Key="SOFTWARE\Microsoft\Office\ClickToRun\Configuration" 
                      Name="VersionToReport" 
                      Type="raw" />
    </Property>

    <!-- Launch conditions -->
    <Condition Message="This application requires .NET Framework 4.8 or higher.">
      <![CDATA[Installed OR NETFRAMEWORK48 >= "#528040"]]>
    </Condition>
    
    <Condition Message="This application requires Microsoft Excel 2016 or higher.">
      <![CDATA[Installed OR OFFICEVERSION]]>
    </Condition>

    <!-- Feature definition -->
    <Feature Id="ProductFeature" 
             Title="SnipperClone Core" 
             Description="Core SnipperClone functionality including OCR engine, table parser, and Excel integration"
             Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="WebAssets" />
      <ComponentGroupRef Id="Dependencies" />
    </Feature>

    <!-- Optional features -->
    <Feature Id="DocumentationFeature" 
             Title="Documentation" 
             Description="User guides, API documentation, and help files"
             Level="1000">
      <ComponentGroupRef Id="DocumentationComponents" />
    </Feature>

    <!-- Installation directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="CompanyFolder" Name="Internal Development Team">
          <Directory Id="INSTALLFOLDER" Name="SnipperClone">
            <Directory Id="WebAssetsFolder" Name="WebAssets" />
            <Directory Id="DocumentationFolder" Name="Documentation" />
          </Directory>
        </Directory>
      </Directory>
      
      <!-- Start Menu -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="SnipperClone" />
      </Directory>
      
      <!-- Desktop -->
      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>

    <!-- Main application components -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <!-- Main assembly -->
      <Component Id="MainAssembly" Guid="11111111-2222-3333-4444-555555555555">
        <File Id="SnipperClone.dll" 
              Source="SnipperClone\bin\Release\SnipperClone.dll" 
              KeyPath="yes" />
        
        <!-- COM registration -->
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Classes\SnipperClone.Connect" 
                       Value="SnipperClone - DataSnipper Alternative" 
                       Type="string" />
        
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Classes\SnipperClone.Connect\CLSID" 
                       Value="{12345678-1234-1234-1234-123456789012}" 
                       Type="string" />
        
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Classes\CLSID\{12345678-1234-1234-1234-123456789012}" 
                       Value="SnipperClone - DataSnipper Alternative" 
                       Type="string" />
        
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Classes\CLSID\{12345678-1234-1234-1234-123456789012}\InprocServer32" 
                       Value="mscoree.dll" 
                       Type="string" />
        
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Classes\CLSID\{12345678-1234-1234-1234-123456789012}\InprocServer32" 
                       Name="ThreadingModel" 
                       Value="Both" 
                       Type="string" />
        
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Classes\CLSID\{12345678-1234-1234-1234-123456789012}\InprocServer32" 
                       Name="Class" 
                       Value="SnipperClone.Connect" 
                       Type="string" />
        
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Classes\CLSID\{12345678-1234-1234-1234-123456789012}\InprocServer32" 
                       Name="Assembly" 
                       Value="SnipperClone" 
                       Type="string" />
        
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Classes\CLSID\{12345678-1234-1234-1234-123456789012}\InprocServer32" 
                       Name="RuntimeVersion" 
                       Value="v4.0.30319" 
                       Type="string" />
        
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Classes\CLSID\{12345678-1234-1234-1234-123456789012}\InprocServer32" 
                       Name="CodeBase" 
                       Value="[INSTALLFOLDER]SnipperClone.dll" 
                       Type="string" />
        
        <!-- Excel add-in registration -->
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Microsoft\Office\Excel\Addins\SnipperClone.Connect" 
                       Name="Description" 
                       Value="SnipperClone - DataSnipper Alternative for Excel" 
                       Type="string" />
        
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Microsoft\Office\Excel\Addins\SnipperClone.Connect" 
                       Name="FriendlyName" 
                       Value="SnipperClone" 
                       Type="string" />
        
        <RegistryValue Root="HKLM" 
                       Key="SOFTWARE\Microsoft\Office\Excel\Addins\SnipperClone.Connect" 
                       Name="LoadBehavior" 
                       Value="3" 
                       Type="integer" />
      </Component>
      
      <!-- Configuration files -->
      <Component Id="ConfigFiles" Guid="22222222-3333-4444-5555-666666666666">
        <File Id="SnipperClone.dll.config" 
              Source="SnipperClone\bin\Release\SnipperClone.dll.config" 
              KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Web assets -->
    <ComponentGroup Id="WebAssets" Directory="WebAssetsFolder">
      <Component Id="ViewerHtml" Guid="33333333-4444-5555-6666-777777777777">
        <File Id="viewer.html" 
              Source="SnipperClone\bin\Release\WebAssets\viewer.html" 
              KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Dependencies -->
    <ComponentGroup Id="Dependencies" Directory="INSTALLFOLDER">
      <Component Id="WebView2" Guid="44444444-5555-6666-7777-888888888888">
        <File Id="Microsoft.Web.WebView2.Core.dll" 
              Source="SnipperClone\bin\Release\Microsoft.Web.WebView2.Core.dll" 
              KeyPath="yes" />
        <File Id="Microsoft.Web.WebView2.WinForms.dll" 
              Source="SnipperClone\bin\Release\Microsoft.Web.WebView2.WinForms.dll" />
      </Component>
      
      <Component Id="NewtonsoftJson" Guid="55555555-6666-7777-8888-999999999999">
        <File Id="Newtonsoft.Json.dll" 
              Source="SnipperClone\bin\Release\Newtonsoft.Json.dll" 
              KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Documentation -->
    <ComponentGroup Id="DocumentationComponents" Directory="DocumentationFolder">
      <Component Id="ReadmeFiles" Guid="66666666-7777-8888-9999-AAAAAAAAAAAA">
        <File Id="README_COM.md" 
              Source="README-COM.md" 
              KeyPath="yes" />
        <File Id="CONVERSION_SUMMARY.md" 
              Source="CONVERSION-SUMMARY.md" />
        <File Id="ENHANCEMENT_SUMMARY.md" 
              Source="ENHANCEMENT-SUMMARY.md" />
        <File Id="PROJECT_STATUS.md" 
              Source="PROJECT-STATUS.md" />
      </Component>
    </ComponentGroup>

    <!-- Start Menu shortcuts -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="77777777-8888-9999-AAAA-BBBBBBBBBBBB">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="SnipperClone Documentation"
                  Description="Open SnipperClone user documentation"
                  Target="[DocumentationFolder]README-COM.md"
                  WorkingDirectory="DocumentationFolder" />
        
        <Shortcut Id="UninstallShortcut"
                  Name="Uninstall SnipperClone"
                  Description="Uninstall SnipperClone from your computer"
                  Target="[SystemFolder]msiexec.exe"
                  Arguments="/x [ProductCode]" />
        
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" 
                       Key="Software\Microsoft\SnipperClone" 
                       Name="installed" 
                       Type="integer" 
                       Value="1" 
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Custom actions for advanced installation -->
    <CustomAction Id="RegisterAssembly" 
                  Directory="INSTALLFOLDER" 
                  ExeCommand="[SystemFolder]regasm.exe &quot;[INSTALLFOLDER]SnipperClone.dll&quot; /codebase /tlb" 
                  Execute="deferred" 
                  Impersonate="no" 
                  Return="ignore" />
    
    <CustomAction Id="UnregisterAssembly" 
                  Directory="INSTALLFOLDER" 
                  ExeCommand="[SystemFolder]regasm.exe &quot;[INSTALLFOLDER]SnipperClone.dll&quot; /unregister" 
                  Execute="deferred" 
                  Impersonate="no" 
                  Return="ignore" />

    <!-- Installation sequence -->
    <InstallExecuteSequence>
      <Custom Action="RegisterAssembly" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="UnregisterAssembly" Before="RemoveFiles">Installed AND NOT REINSTALL</Custom>
    </InstallExecuteSequence>

    <!-- UI configuration -->
    <UIRef Id="WixUI_FeatureTree" />
    <UIRef Id="WixUI_ErrorProgressText" />
    
    <!-- License agreement -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    
    <!-- Custom dialogs -->
    <UI>
      <DialogRef Id="WelcomeDlg" />
      <DialogRef Id="LicenseAgreementDlg" />
      <DialogRef Id="CustomizeDlg" />
      <DialogRef Id="VerifyReadyDlg" />
      <DialogRef Id="ProgressDlg" />
      <DialogRef Id="ExitDlg" />
      
      <!-- Custom welcome message -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
      <Publish Dialog="LicenseAgreementDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
      <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="CustomizeDlg">LicenseAccepted = "1"</Publish>
      <Publish Dialog="CustomizeDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
      <Publish Dialog="CustomizeDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="CustomizeDlg">1</Publish>
    </UI>

    <!-- Installation validation -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    
    <!-- Post-installation message -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" 
              Value="SnipperClone has been successfully installed. Please restart Excel to load the add-in. You can find the DATASNIPPER tab in Excel's ribbon after restart." />

  </Product>
</Wix> 